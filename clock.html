<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WorkTime Premium PRO</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --bg: #000; --card: #121212; --accent: #3478F6; --text: #fff; --danger: #A63A32; --success: #32d74b; --gray: #8E8E93; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; margin: 0; padding: 0; touch-action: manipulation; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Header */
        .header { padding: 40px 25px 10px; text-align: right; }
        .job-title { color: var(--accent); font-size: 1.2rem; font-weight: 500; }
        .status-text { font-size: 2.5rem; font-weight: 700; margin-top: 10px; }
        .entry-time { color: var(--accent); font-size: 0.9rem; margin-top: 5px; min-height: 1.2rem; }

        /* Main Content */
        .content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .timer { font-size: 5rem; font-weight: 300; letter-spacing: -2px; margin-bottom: 30px; font-variant-numeric: tabular-nums; }
        .timer.overtime { color: var(--danger); }

        /* Stats Grid */
        .stats { display: grid; grid-template-columns: 1fr 1fr 1fr; width: 100%; max-width: 400px; text-align: center; margin-bottom: 40px; }
        .stat-item { border-left: 1px solid #333; }
        .stat-item:last-child { border-left: none; }
        .stat-val { font-size: 1.1rem; font-weight: 600; display: block; }
        .stat-label { font-size: 0.7rem; color: var(--gray); margin-top: 4px; display: block; }

        /* Buttons */
        .btn-container { width: 100%; max-width: 350px; text-align: center; }
        .btn-break { color: var(--gray); font-size: 0.9rem; font-weight: 600; background: none; border: none; margin-bottom: 25px; cursor: pointer; }
        .btn-main { width: 100%; padding: 18px; border-radius: 12px; border: none; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-entry { background: var(--accent); color: #fff; }
        .btn-exit { background: var(--danger); color: #fff; }
        .btn-manual { background: none; color: var(--accent); margin-top: 20px; font-weight: 600; border: none; cursor: pointer; }

        /* Report Table */
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 15px 5px; border-bottom: 1px solid #222; text-align: center; font-size: 0.9rem; }
        .diff-pos { color: var(--success); }
        .diff-neg { color: var(--danger); }
        .trash-btn { background: none; border: none; cursor: pointer; font-size: 1rem; opacity: 0.5; }

        /* Bottom Nav */
        .nav { background: #0A0A0A; border-top: 1px solid #1C1C1E; display: grid; grid-template-columns: repeat(4, 1fr); padding: 10px 0 30px; }
        .nav-item { text-align: center; color: var(--gray); font-size: 0.65rem; text-decoration: none; cursor: pointer; }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 1.4rem; display: block; margin-bottom: 4px; }

        #loginOverlay { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }
    </style>
</head>
<body>

<div id="loginOverlay"><button onclick="login()" class="btn-main btn-entry" style="width:200px">×”×ª×—×‘×¨×•×ª ×¢× Google</button></div>

<div id="screen-timer" class="screen active">
    <div class="header">
        <div class="job-title">×¢×‘×•×“×” 1</div>
        <div class="status-text">×©×¢×•×Ÿ</div>
        <div class="entry-time" id="entryDisplay"></div>
    </div>

    <div class="content">
        <div id="currentFullDate" style="color:var(--gray); font-size:0.8rem; margin-bottom:10px"></div>
        <div class="timer" id="display">00:00:00</div>
        
        <div class="stats">
            <div class="stat-item"><span class="stat-val" id="exitTime">--:--</span><span class="stat-label">×©×¢×ª ×™×¦×™××”</span></div>
            <div class="stat-item"><span class="stat-val" id="overtimeVal">0 ×“×§'</span><span class="stat-label">×—×¨×™×’×”</span></div>
            <div class="stat-item"><span class="stat-val" id="breakVal">--</span><span class="stat-label">×”×¤×¡×§×”</span></div>
        </div>

        <div class="btn-container">
            <button class="btn-break" onclick="alert('×¤×•× ×§×¦×™×™×ª ×”×¤×¡×§×” ×‘×¤×™×ª×•×—')">×§×— ×”×¤×¡×§×”</button>
            <button id="shiftBtn" class="btn-main btn-entry" onclick="toggleShift()">×›× ×™×¡×”</button>
            <button class="btn-manual" onclick="manualAdd()">+ ×”×•×¡×¤×” ×™×“× ×™×ª</button>
        </div>
    </div>
</div>

<div id="screen-report" class="screen">
    <div class="header"><div class="status-text">×’×™×œ×™×•×Ÿ ×¢×‘×•×“×”</div></div>
    <div style="padding: 20px; flex: 1; overflow-y: auto;">
        <table id="logTable"></table>
    </div>
</div>

<nav class="nav">
    <div class="nav-item active" onclick="showScreen('timer')"><span class="nav-icon">ğŸ•’</span>×©×¢×•×Ÿ</div>
    <div class="nav-item" onclick="showScreen('report')"><span class="nav-icon">ğŸ“‹</span>×“×•×—×•×ª</div>
    <div class="nav-item" onclick="alert('××•×“×•×œ ×¢×‘×•×“×•×ª ×‘×¤×™×ª×•×—')"><span class="nav-icon">ğŸ’¼</span>×¢×‘×•×“×•×ª</div>
    <div class="nav-item" onclick="promptSettings()"><span class="nav-icon">âš™ï¸</span>×”×’×“×¨×•×ª</div>
</nav>

<script>
    const firebaseConfig = { apiKey: "AIzaSyB6k04PIDrtH0lN1mMH8d4mrQbU_Wd6EPY", authDomain: "clooc-87768.firebaseapp.com", projectId: "clooc-87768", storageBucket: "clooc-87768.firebasestorage.app", messagingSenderId: "446568496274", appId: "1:446568496274:web:c1aead85e32d21d0e5ba4b" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(); const db = firebase.firestore();
    let user = null, timerInt, std = 9;

    async function login() { 
        try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } 
        catch(e) { alert("×©×’×™××ª ×”×ª×—×‘×¨×•×ª: " + e.message); }
    }

    auth.onAuthStateChanged(async u => {
        if(u) {
            user = u; 
            document.getElementById('loginOverlay').style.display = 'none';
            await loadSettings();
            loadData(); 
            checkActive(); 
            updateUI();
        }
    });

    function updateUI() {
        const now = new Date();
        document.getElementById('currentFullDate').innerText = now.toLocaleDateString('he-IL', {weekday:'long', day:'2-digit', month:'2-digit', year:'numeric'});
    }
    setInterval(updateUI, 1000);

    async function loadSettings() {
        try {
            const doc = await db.collection('users').doc(user.uid).get();
            if(doc.exists && doc.data().std) std = parseFloat(doc.data().std);
        } catch(e) { console.error(e); }
    }

    async function toggleShift() {
        const start = localStorage.getItem('active_start');
        
        if(!start) {
            // ×”×ª×—×œ×ª ××©××¨×ª
            localStorage.setItem('active_start', new Date().toISOString());
            checkActive();
        } else {
            // ×¡×™×•× ××©××¨×ª
            const hours = (new Date() - new Date(start)) / 3600000;
            const dateStr = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            
            try {
                // ×©××™×¨×” ×œ×“××˜×” ×‘×™×™×¡
                await db.collection('users').doc(user.uid).collection('logs').doc(dateStr).set({
                    date: dateStr, 
                    hours: parseFloat(hours.toFixed(2)), 
                    timestamp: Date.now()
                });
                
                // ××™×¤×•×¡ ×××©×§ (×œ×œ× ×¨×™×¢× ×•×Ÿ ×“×£!)
                localStorage.removeItem('active_start');
                clearInterval(timerInt);
                
                // ×¢×“×›×•×Ÿ UI ×œ××¦×‘ ×”×ª×—×œ×ª×™
                document.getElementById('display').innerText = "00:00:00";
                document.getElementById('display').classList.remove('overtime');
                document.getElementById('entryDisplay').innerText = "";
                document.getElementById('exitTime').innerText = "--:--";
                document.getElementById('overtimeVal').innerText = "0 ×“×§'";
                
                const btn = document.getElementById('shiftBtn');
                btn.innerText = "×›× ×™×¡×”"; 
                btn.className = "btn-main btn-entry";
                
                await loadData(); // ×¨×¢× ×•×Ÿ ×”×˜×‘×œ×”
                alert("×”××©××¨×ª × ×©××¨×” ×‘×”×¦×œ×—×”!");
                
            } catch(e) {
                alert("×©×’×™××” ×‘×©××™×¨×”, × ×¡×” ×©×•×‘: " + e.message);
            }
        }
    }

    function checkActive() {
        const start = localStorage.getItem('active_start');
        if(start) {
            const btn = document.getElementById('shiftBtn');
            btn.innerText = "×™×¦×™××”"; 
            btn.className = "btn-main btn-exit";
            
            const entry = new Date(start);
            document.getElementById('entryDisplay').innerText = `× ×›× ×¡×ª ×‘×©×¢×” ${entry.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
            
            // ×—×™×©×•×‘ ×—××™×©×™
            const dayStd = entry.getDay() === 4 ? std - 1 : std;
            const exit = new Date(entry.getTime() + dayStd * 3600000);
            document.getElementById('exitTime').innerText = exit.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

            // × ×™×§×•×™ ×˜×™×™××¨ ×§×™×™× ×× ×™×©
            if(timerInt) clearInterval(timerInt);

            timerInt = setInterval(() => {
                const now = new Date();
                const s = Math.floor((now - entry) / 1000);
                let rem = (dayStd * 3600) - s;
                
                if(rem < 0) { 
                    document.getElementById('display').classList.add('overtime');
                    document.getElementById('overtimeVal').innerText = Math.floor(Math.abs(rem)/60) + " ×“×§'";
                    rem = Math.abs(rem);
                } else {
                    document.getElementById('display').classList.remove('overtime');
                    document.getElementById('overtimeVal').innerText = "0 ×“×§'";
                }
                
                const h = Math.floor(rem/3600).toString().padStart(2,'0');
                const m = Math.floor((rem%3600)/60).toString().padStart(2,'0');
                const sec = (rem%60).toString().padStart(2,'0');
                document.getElementById('display').innerText = `${h}:${m}:${sec}`;
            }, 1000);
        }
    }

    async function manualAdd() {
        const dateStr = prompt("×ª××¨×™×š (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
        if(!dateStr) return;
        const h = prompt("×›××” ×©×¢×•×ª?");
        if(h && !isNaN(h)) {
            try {
                await db.collection('users').doc(user.uid).collection('logs').doc(dateStr).set({
                    date: dateStr, hours: parseFloat(h), timestamp: Date.now()
                });
                await loadData();
                alert("× ×•×¡×£ ×‘×”×¦×œ×—×”");
            } catch(e) { alert("×©×’×™××”: " + e.message); }
        }
    }

    async function loadData() {
        const snap = await db.collection('users').doc(user.uid).collection('logs').orderBy('timestamp', 'desc').limit(31).get();
        let html = '';
        
        snap.forEach(doc => {
            const d = doc.data();
            const dateObj = new Date(d.date);
            // ×—×™×©×•×‘ ×—×¨×™×’×” ×œ×“×•×—
            const dailyStd = dateObj.getDay() === 4 ? std - 1 : std;
            const diff = (d.hours - dailyStd).toFixed(1);
            const diffClass = diff >= 0 ? 'diff-pos' : 'diff-neg';
            const dateDisplay = d.date.split('-').reverse().slice(0,2).join('/'); // DD/MM
            
            html += `<tr>
                <td>${dateDisplay}</td>
                <td style="font-weight:bold">${d.hours}</td>
                <td class="${diffClass}">${diff > 0 ? '+' : ''}${diff}</td>
                <td><button class="trash-btn" onclick="deleteLog('${doc.id}')">ğŸ—‘ï¸</button></td>
            </tr>`;
        });
        document.getElementById('logTable').innerHTML = html;
    }

    async function deleteLog(id) {
        if(confirm('×œ××—×•×§ ×¨×©×•××” ×–×•?')) {
            await db.collection('users').doc(user.uid).collection('logs').doc(id).delete();
            loadData();
        }
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    function promptSettings() {
        const val = prompt("×”×›× ×¡ ×ª×§×Ÿ ×™×•××™ ×©×¢×•×ª (×-×“):", std);
        if(val && !isNaN(val)) { 
            db.collection('users').doc(user.uid).set({std: val}, {merge:true}); 
            std = parseFloat(val);
            alert("×”×’×“×¨×•×ª × ×©××¨×•");
            checkActive(); // ×—×™×©×•×‘ ××—×“×© ×©×œ ×™×¢×“ ×”×™×¦×™××”
            loadData(); // ×—×™×©×•×‘ ××—×“×© ×©×œ ×”×“×•×—
        }
    }
</script>
</body>
</html>

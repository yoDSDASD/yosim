<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WorkTime Ultimate</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --bg: #050505; --card: #121212; --accent: #3d8bff; --text: #ffffff; --text-dim: #a0a0a0; --border: #222; --success: #00e676; --danger: #ff1744; }
        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 15px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        
        .card { background: var(--card); width: 100%; max-width: 500px; border-radius: 24px; padding: 25px; border: 1px solid var(--border); margin-bottom: 20px; }
        .timer { font-size: 4rem; font-weight: 200; text-align: center; margin: 20px 0; font-variant-numeric: tabular-nums; letter-spacing: -2px; }
        .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 0.85rem; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        button { padding: 16px; border-radius: 14px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 1rem; }
        .btn-in { background: var(--text); color: var(--bg); }
        .btn-out { background: transparent; color: var(--text); border: 1px solid var(--border); }
        .btn-add { background: var(--accent); color: white; width: 100%; margin-top: 15px; }
        
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #1a1a1a; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border); }
        .item-actions { display: flex; gap: 12px; }
        .action-icon { cursor: pointer; opacity: 0.6; font-size: 0.9rem; }
        
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px; }
        input { background: #1a1a1a; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 8px; width: 100%; margin-top: 5px; }
        
        #loginOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <h1>WorkTime Premium</h1>
    <button onclick="login()" style="background: white; color: black; padding: 15px 30px; border-radius: 12px;">×”×ª×—×‘×¨ ×¢× Google</button>
</div>

<div class="card">
    <div class="status-header">
        <div id="statusBadge" style="color: var(--text-dim);">××—×•×¥ ×œ××©××¨×ª</div>
        <div id="monthlyPay" style="font-weight: bold; color: var(--success);">â‚ª0.00</div>
    </div>
    
    <div class="timer" id="display">00:00:00</div>
    
    <div class="btn-group">
        <button class="btn-out" onclick="punchOut()">×¡×™×•×</button>
        <button class="btn-in" onclick="punchIn()">×›× ×™×¡×”</button>
    </div>
</div>

<div class="card">
    <div style="font-weight: bold; margin-bottom: 15px;">×”×™×¡×˜×•×¨×™×” ×•× ×™×”×•×œ</div>
    <div id="historyList"></div>
    <button class="btn-add" onclick="manualAdd()">+ ×”×•×¡×¤×” ×™×“× ×™×ª</button>
    <button class="btn-add" style="background: #333;" onclick="exportPDF()">ğŸ“„ ×”×¤×§ ×“×•"×— PDF ×œ××™×™×œ</button>
</div>

<div class="card">
    <div class="config-grid">
        <div><label style="font-size: 0.7rem; color: var(--text-dim);">â‚ª ×œ×©×¢×”</label><input type="number" id="rate" value="50"></div>
        <div><label style="font-size: 0.7rem; color: var(--text-dim);">×ª×§×Ÿ (×—××™×©×™ ×©×¢×” ×¤×—×•×ª)</label><input type="number" id="std" value="9.5"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB6k04PIDrtH0lN1mMH8d4mrQbU_Wd6EPY",
        authDomain: "clooc-87768.firebaseapp.com",
        projectId: "clooc-87768",
        storageBucket: "clooc-87768.firebasestorage.app",
        messagingSenderId: "446568496274",
        appId: "1:446568496274:web:c1aead85e32d21d0e5ba4b"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let user = null;

    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    async function login() { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

    auth.onAuthStateChanged(u => {
        if (u) { user = u; document.getElementById('loginOverlay').style.display='none'; loadData(); checkActive(); }
    });

    function punchIn() {
        localStorage.setItem('job_start', new Date().toISOString());
        checkActive();
    }

    async function punchOut() {
        const start = localStorage.getItem('job_start');
        if(!start) return;
        const diff = (new Date() - new Date(start)) / 3600000;
        await saveLog(new Date().toLocaleDateString('he-IL'), diff);
        localStorage.removeItem('job_start');
        location.reload();
    }

    async function saveLog(date, hours) {
        const rate = parseFloat(document.getElementById('rate').value);
        const isThursday = new Date().getDay() === 4;
        const standard = isThursday ? parseFloat(document.getElementById('std').value) - 1 : parseFloat(document.getElementById('std').value);
        
        let pay = hours <= standard ? hours * rate : (standard * rate) + ((hours - standard) * rate * 1.25);
        
        await db.collection('users').doc(user.uid).collection('logs').add({
            date, hours: parseFloat(hours.toFixed(2)), pay: Math.round(pay), timestamp: Date.now()
        });
    }

    async function loadData() {
        const snap = await db.collection('users').doc(user.uid).collection('logs').orderBy('timestamp', 'desc').get();
        const logs = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        
        let total = 0;
        document.getElementById('historyList').innerHTML = logs.slice(0,10).map(l => {
            total += l.pay;
            return `
            <div class="history-item">
                <div><small>${l.date}</small><br><b>${l.hours} ×©'</b></div>
                <div class="item-actions">
                    <span>â‚ª${l.pay}</span>
                    <span class="action-icon" onclick="deleteItem('${l.id}')">ğŸ—‘ï¸</span>
                </div>
            </div>`;
        }).join('');
        document.getElementById('monthlyPay').innerText = `â‚ª${total}`;
    }

    async function deleteItem(id) {
        if(confirm('×œ××—×•×§?')) {
            await db.collection('users').doc(user.uid).collection('logs').doc(id).delete();
            loadData();
        }
    }

    function manualAdd() {
        const h = prompt("×›××” ×©×¢×•×ª?");
        if(h) saveLog(new Date().toLocaleDateString('he-IL'), parseFloat(h)).then(loadData);
    }

    function checkActive() {
        const start = localStorage.getItem('job_start');
        if(start) {
            document.getElementById('statusBadge').innerText = "××©××¨×ª ×¤×¢×™×œ×”";
            document.getElementById('statusBadge').style.color = "var(--success)";
            setInterval(() => {
                const s = Math.floor((new Date() - new Date(start)) / 1000);
                document.getElementById('display').innerText = new Date(s * 1000).toISOString().substr(11, 8);
            }, 1000);
        }
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Work Report", 10, 10);
        doc.autoTable({ html: '#historyList' }); // Simplification for demo
        doc.save("report.pdf");
        alert("×”×“×•-×— ×™×¨×“ ×œ× ×™×™×“. ×ª×•×›×œ ×œ×©×ª×£ ××•×ª×• ×œ××™×™×œ/×•×•××˜×¡××¤.");
    }
</script>
</body>
</html>

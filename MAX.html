<script>
const fmt = v => Number(v).toFixed(3);

// מקריאים מספר בבטחה: תומך בפסיקים/רווחים
function readNum(id){
  const el = document.getElementById(id);
  if(!el) return NaN;
  const raw = String(el.value).trim().replace(/,/g,'.');
  const n = parseFloat(raw);
  return isNaN(n) ? NaN : n;
}

function blurInputs(){ document.querySelectorAll('input').forEach(el=>el.blur()); }

function calc(){
  blurInputs();

  const nom = readNum('nominal');
  const tp  = readNum('tolp');   // +TOL
  const tm  = readNum('tolm');   // -TOL

  const seriesBox = document.getElementById('series');
  const resultBox = document.getElementById('resultBox');

  // ניקוי קודם
  seriesBox.innerHTML = '';
  seriesBox.style.display = 'none';

  if (isNaN(nom)) {
    resultBox.style.display='block';
    resultBox.innerHTML='יש להזין ערך נומינלי תקין';
    return;
  }

  const up = isNaN(tp) ? 0 : tp;
  const lo = isNaN(tm) ? 0 : tm;

  // חישוב גבולות
  const max = nom + up;
  const min = nom - lo;

  // הצגה ברורה בשורה אחת
  resultBox.innerHTML =
    `<strong>תוצאה:</strong><br>` +
    `<span style="font-size:1.1rem"><b>${fmt(max)}</b> ⇐ קדח ⇒ <b>${fmt(min)}</b></span>`;
  resultBox.style.display = 'block';

  // יצירת סדרת פינים בתקינה 0.01 מ״מ
  const step = 0.01;

  // עיגול לדרגת פינים (למעלה למינימום, למטה למקסימום)
  const start = Math.ceil(min * 100) / 100;
  const end   = Math.floor(max * 100) / 100;

  let html = '';
  if (start > end) {
    html = 'אין פינים בתחום זה';
  } else {
    const goVal   = start; // לקדח: Go = הקטן
    const noGoVal = end;   // No-Go = הגדול

    // לולאה יציבה מתמטית למניעת שגיאות ציפה
    for (let i = Math.round(start*100); i <= Math.round(end*100); i += 1) {
      const v = i / 100;
      const val = fmt(v);
      if (i === Math.round(goVal*100))   html += `<div class="pin go">${val} <b>Go</b></div>`;
      else if (i === Math.round(noGoVal*100)) html += `<div class="pin nogo">${val} <b>No-Go</b></div>`;
      else html += `<div class="pin">${val}</div>`;
    }
  }

  seriesBox.innerHTML = html;
  seriesBox.style.display = 'block';
}

function resetAll(){
  blurInputs();
  ['nominal','tolp','tolm'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('resultBox').style.display='none';
  document.getElementById('resultBox').innerHTML='';
  const box=document.getElementById('series');
  box.innerHTML='';
  box.style.display='none';
}
</script>
